@model IEnumerable<Members.Models.CategoryFile>
@using Members.Models

@{
    ViewData["Title"] = "Manage Files in Category";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var allMembersCategories = ViewBag.PDFCategories as List<PDFCategory> ?? new List<PDFCategory>();
    var selectedCategoryId = ViewBag.SelectedCategoryId as int?;
    var selectedCategory = selectedCategoryId.HasValue ? allMembersCategories.FirstOrDefault(c => c.CategoryID == selectedCategoryId.Value) : null;

    if (selectedCategory != null)
    {
        ViewData["Title"] = $"Manage Files: {selectedCategory.CategoryName}";
    }
}

<!-- Page Header -->
<div class="mb-4">
    <!-- 1. Page Title - Centered -->
    <div class="text-center">
        <h2><i class="bi bi-folder-symlink"></i> 
        @if (selectedCategory != null)
        {
            <span>Manage Files: @selectedCategory.CategoryName</span>
        }
        else
        {
            <span>Manage Member PDF Files</span>
        }
        </h2>
    </div>
    
    <!-- 2. Description - Centered -->
    <div class="text-center">
        <p>Upload, organize, and manage PDF files within categories</p>
    </div>
    
    <!-- 3. Navigation Buttons - Centered on Mobile -->
    <div class="text-center">
        <a asp-controller="PdfCategory" asp-action="Categories" class="btn btn-sm btn-back rounded-2 shadow">
            <i class="bi bi-arrow-left-square"></i> Back to Manage Categories
        </a>
    </div>
</div>

<div class="my-4 m-0 p-0">
    <div class="row justify-content-center m-1 p-0">
        <div class="col-md-8 col-lg-6 m-0 p-0">

            <div class="card mb-3 rounded p-2 shadow">

                <!-- Category Selection Dropdown -->
                <form method="get" asp-controller="PdfCategory" asp-action="ManageCategoryFiles" class="mb-4">

                    <label for="categoryIdSelection" class="fw-bold">Select Category to Manage Files:</label>
                    <select name="categoryId" id="categoryIdSelection" class="form-select" asp-items="@(new SelectList(allMembersCategories, "CategoryID", "CategoryName", selectedCategoryId))" onchange="this.form.submit()">
                        <option value="">-- Select a Category --</option>
                    </select>

                </form>
            </div>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">@TempData["SuccessMessage"]<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">@TempData["ErrorMessage"]<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>
    }

    @if (selectedCategoryId.HasValue && selectedCategory != null)
    {
        <!-- Upload Form -->
        <div class="mb-4 mx-0 p-0">
            <div class="row justify-content-center m-1 p-0">
                <div class="col-md-8 col-lg-6 m-0 p-0">

                    <div class="card rounded shadow mb-4">
                        <div class="card-header fw-bold ">
                            <i class="bi bi-cloud-upload-fill"></i> Upload New PDF to '@selectedCategory.CategoryName'
                        </div>
                        <div class="card-body rounded-2 px-1">
                            <form method="post" enctype="multipart/form-data" asp-controller="PdfCategory" asp-action="UploadFileToCategory">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="categoryId" value="@selectedCategoryId.Value" />
                                <div class="row gx-0 gy-2 align-items-center">

                                    <div class="col-8">
                                        <label for="fileUpload" class="fw-bold ms-2">PDF Document:</label>
                                        <input type="file" name="file" id="fileUpload" class="form-control no-right-radius mt-2" required accept=".pdf">
                                    </div>

                                    <div class="col-2">
                                        <label for="sortOrder" class="fw-bold">Sort:</label>
                                        <input type="number" name="sortOrder" id="sortOrder" class="form-control no-left-radius no-right-radius mt-2" value="1" min="1" required>
                                    </div>

                                    <div class="col-2 align-self-end">
                                        <button type="submit" class="no-left-radius btn btn-success w-100"><i class="bi bi-upload"></i></button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Existing Files Card-Header -->
                    <div class="card-header fw-bold mt-2 p-2 rounded-top">
                        <h5 class="text-black"><i class="bi bi-list-task"></i> Existing Files in:</h5>
                        <h5 class="text-black fw-bold mb-2 ms-4">@selectedCategory.CategoryName</h5>
                    </div>                    

                    @if (Model == null || !Model.Any())
                    {
                        <div class="alert alert-primary mt-2">No files in this category.</div>
                    }
                    else
                    {
                        <div class="table-responsive rounded-bottom shadow">
                            <table class="table-striped w-100 shadow">
                                <thead>
                                    <tr>
                                        <th class="header-text ps-2" width="5%">Order</th>
                                        <th class="header-text text-center" width="8%">Edit</th>
                                        <th class="header-text text-center" width="8%">View</th>
                                        <th class="header-text text-start" width="54%">File Name (Click to Edit)</th>
                                        <th class="header-text text-end pe-2" width="25%">Delete</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var file in Model.OrderBy(f => f.SortOrder).ThenBy(f => f.FileName))
                                    {
                                        <tr id="display-row-@file.FileID" data-file-id="@file.FileID" data-file-name="@file.FileName" data-sort-order="@file.SortOrder" data-category-id="@selectedCategoryId.Value">
                                            
                                            <!-- Drag Handle and Sort Order -->
                                            <td class="text-center py-0">
                                                <div class="d-flex align-items-center justify-content-center">
                                                    <span class="drag-handle me-2" title="Drag to reorder">
                                                        <i class="bi bi-grip-vertical"></i>
                                                    </span>
                                                    <span class="badge bg-secondary">@file.SortOrder</span>
                                                </div>
                                            </td>
                                            
                                            <td class="p-0 text-center align-middle">
                                                <button type="button" class="btn btn-sm" title="Edit name/sort order"
                                                        onclick="showRenameModal('@file.FileID', '@file.FileName', '@file.SortOrder', '@selectedCategoryId.Value')">
                                                    <i class="bi bi-pencil-square text-green"></i>
                                                </button>
                                            </td>
                                            <td class="p-0 text-center align-middle">
                                                <a class="btn btn-sm px-2 py-1" href="/identity/ViewPdf?fileName=@file.FileName" title="View PDF">
                                                    <i class="bi bi-eye text-eye-view"></i>
                                                </a>
                                            </td>
                                            <td class="nav py-2 filename-cell align-middle text-nowrap" style="cursor:pointer;" title="Edit name/sort order"
                                                onclick="showRenameModal('@file.FileID', '@file.FileName', '@file.SortOrder', '@selectedCategoryId.Value')">
                                                @System.IO.Path.GetFileNameWithoutExtension(file.FileName)
                                            </td>
                                            <td class="p-0 text-end align-middle">
                                                <form method="post" asp-controller="PdfCategory" asp-action="DeleteFileFromCategory" asp-route-id="@file.FileID" asp-route-categoryId="@selectedCategoryId.Value" class="d-inline" id="deleteFileForm_@file.FileID">
                                                    @Html.AntiForgeryToken()
                                                    <button type="button" class="btn btn-sm btn-delete px-2 py-1" title="Delete File"
                                                            data-file-name="@file.FileName" data-form-id="deleteFileForm_@file.FileID"
                                                            onclick="confirmDeleteFile(this)">
                                                        <i class="bi bi-trash-fill"></i>
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                    }

                </div>
            </div>
        </div>
    }
    else if (allMembersCategories.Any())
    {
        <div class="row justify-content-center m-1 p-0">
            <div class="col-md-8 col-lg-6 m-0 p-0">
                <div class="alert alert-info mt-3 shadow">
                    Select a category to manage its files.
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="row justify-content-center m-1 p-0">
            <div class="col-md-8 col-lg-6 m-0 p-0">
                <div class="alert alert-warning mt-3 shadow">
                    No Members categories exist. <a asp-controller="PdfCategory" asp-action="Categories" class="alert-link">Create one</a>.
                </div>
            </div>
        </div>
    }

</div>

<!-- Rename/Sort Modal for Manager Files -->
<div class="modal fade" id="RenameModal" tabindex="-1" aria-labelledby="RenameModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header card-header rounded-top">
                <h5 class="modal-title" id="RenameModalLabel">Edit File Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body pb-0">
                <input type="hidden" id="RenameFileId" /><input type="hidden" id="OldFileName" /><input type="hidden" id="FileCategoryId" />
                <div class="row align-items-center mb-2">
                    <div class="col-sm-3"><label for="NewFileName" class="col-form-label fw-bold">File Name:</label></div>
                    <div class="col-sm-9"><input type="text" class="form-control" id="NewFileName"></div>
                </div>
                <div class="row align-items-center mb-3">
                    <div class="col-sm-3"><label for="NewSortOrder" class="col-form-label fw-bold">Sort Order:</label></div>
                    <div class="col-sm-9"><input type="number" class="form-control" id="NewSortOrder" min="1"></div>
                </div>
                <div class="alert alert-info small p-2">Do not include '.pdf' extension. Physical file will be renamed if name changes.</div>
            </div>
            <div class="modal-footer border-top-0">
                <button type="button" class="btn btn-sm btn-secondary rounded-2 shadow" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-sm btn-primary shadow" onclick="submitRenameForm()">Save</button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>

        .table th, .table td {
            vertical-align: middle;
        }

    </style>
}

@section Scripts {
    <script>
        // Function to confirm file deletion
        function confirmDeleteFile(button) {
            const fileName = button.getAttribute('data-file-name');
            const formId = button.getAttribute('data-form-id');
            showConfirmModal(
                'Are you sure you want to delete the file <strong>' + fileName + '</strong> from this category?<br/><br/>This action cannot be undone.',
                function() {
                    document.getElementById(formId).submit();
                },
                { title: 'Delete File', confirmText: 'Delete' }
            );
        }

        function showRenameModal(fileId, fileName, sortOrder, categoryId) {
            document.getElementById('RenameFileId').value = fileId;
            document.getElementById('OldFileName').value = fileName;
            document.getElementById('NewFileName').value = fileName.substring(0, fileName.lastIndexOf('.'));
            document.getElementById('NewSortOrder').value = sortOrder;
            document.getElementById('FileCategoryId').value = categoryId;
            new bootstrap.Modal(document.getElementById('RenameModal')).show();
        }

        function submitRenameForm() {
            var fileId = document.getElementById('RenameFileId').value;
            var oldFileName = document.getElementById('OldFileName').value;
            var newFileNameNoExt = document.getElementById('NewFileName').value;
            var newSortOrder = document.getElementById('NewSortOrder').value;
            var categoryId = document.getElementById('FileCategoryId').value;

            if (!newFileNameNoExt.trim()) { alert('File name cannot be empty.'); return; }
            if (parseInt(newSortOrder) < 1) { alert('Sort order must be >= 1.'); return; }
            var newFileNameWithExt = newFileNameNoExt + '.pdf';

            var formData = new FormData();
            formData.append("renameFileId", fileId);
            formData.append("categoryId", categoryId);
            formData.append("oldFileName", oldFileName);
            formData.append("newFileName", newFileNameWithExt);
            formData.append("newSortOrder", newSortOrder);

            var token = $('form[asp-controller="PdfCategory"][asp-action="UploadFileToMembersCategory"] input[name="__RequestVerificationToken"]').first().val();
            if (!token) { token = $('input[name="__RequestVerificationToken"]').first().val(); }
            if (!token) { alert("Security token missing."); return; }

            fetch('@Url.Action("RenameFileInCategory", "PdfCategory")', {
                method: 'POST', body: formData, headers: { 'RequestVerificationToken': token }
            })
            .then(response => {
                if (!response.ok) { return response.text().then(text => { throw new Error(text || 'Server error.') }); }
                window.location.href = '@Url.Action("ManageCategoryFiles", "PdfCategory")?categoryId=' + categoryId;
            })
            .catch(error => { alert('Error updating file: ' + error.message); });
        }

        document.addEventListener('DOMContentLoaded', function() {
            var categorySelect = document.getElementById('categoryIdSelection');
            var currentSelectedCategoryId = "@selectedCategoryId";
            if (categorySelect && currentSelectedCategoryId) {
                 fetchNextSortOrderFor(currentSelectedCategoryId, 'sortOrder');
            }
        });

        function fetchNextSortOrderFor(categoryId, targetInputId) {
            if (categoryId) {
                fetch(`@Url.Action("GetNextSortOrder", "PdfCategory")?categoryId=${categoryId}`)
                    .then(response => response.ok ? response.json() : Promise.reject('Failed to fetch sort order'))
                    .then(data => { document.getElementById(targetInputId).value = data; })
                    .catch(error => { console.error(error); document.getElementById(targetInputId).value = 1; });
            }
        }

        // Initialize drag and drop functionality
        document.addEventListener('DOMContentLoaded', function() {
            const tbody = document.querySelector('table tbody');
            if (tbody && tbody.children.length > 0) {
                const sortable = Sortable.create(tbody, {
                    handle: '.drag-handle',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    onEnd: function (evt) {
                        updateFilesSortOrder();
                    }
                });
            }
        });

        function updateFilesSortOrder() {
            const rows = document.querySelectorAll('table tbody tr');
            const updates = [];
            
            rows.forEach((row, index) => {
                const fileId = row.getAttribute('data-file-id');
                if (fileId) {
                    updates.push({
                        fileId: parseInt(fileId),
                        newSortOrder: index + 1
                    });
                    
                    // Update the sort order badge
                    const badge = row.querySelector('.badge.bg-secondary');
                    if (badge) {
                        badge.textContent = index + 1;
                    }
                    
                    // Update data attribute for consistency
                    row.setAttribute('data-sort-order', index + 1);
                }
            });

            // Send updates to server
            const formData = new FormData();
            formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]')?.value || '');
            updates.forEach(update => {
                formData.append('fileIds', update.fileId);
                formData.append('sortOrders', update.newSortOrder);
            });

            fetch('@Url.Action("UpdateFilesSortOrder", "PdfCategory")', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Files reordered successfully!', 'success');
                } else {
                    throw new Error(data.message || 'Failed to update sort order');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Error updating sort order. Please refresh and try again.', 'error');
            });
        }

        function showMessage(message, type) {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    </script>

    <style>
    /* Drag and drop styling */
    .sortable-ghost {
        opacity: 0.4;
    }
    .sortable-chosen {
        background-color: #e3f2fd !important;
    }
    .drag-handle {
        cursor: grab;
        padding: 0.25rem;
    }
    .drag-handle:active {
        cursor: grabbing;
    }
    tbody tr:hover .drag-handle {
        color: #0d6efd !important;
    }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
}