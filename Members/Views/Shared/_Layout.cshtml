@using Microsoft.AspNetCore.Identity
@using System.IO;
@using Microsoft.AspNetCore.Mvc;
@using Microsoft.AspNetCore.Mvc.ViewComponents;
@using Microsoft.EntityFrameworkCore;
@using System.Linq;
@using System.Threading.Tasks;
@using System.Collections.Generic;
@using Members.Data;
@using Members.Models;

@inject SignInManager<IdentityUser> SignInManager
@inject UserManager<IdentityUser> UserManager

@{
    // This Site
    string siteURL = Environment.GetEnvironmentVariable("SITE_URL_OAKS_VILLAGE")!;
    string siteName = Environment.GetEnvironmentVariable("SITE_NAME_OAKS_VILLAGE")!;
    string siteOrg = Environment.GetEnvironmentVariable("SITE_ORG")!;

    // Set Site Name and Description (Change as needed)
    string description = ViewData["Description"]?.ToString() ?? "Welcome to " + siteName + ".";

    string siteNameShort = siteName;
    string siteOrganization = siteOrg;

    // Set default values
    string pageTitle = ViewData["Title"]?.ToString() ?? siteName;

    // Page Share Settings - (shows on "PageShare" card when a link is shared)
    string ogSite_Name = siteOrganization;
    string ogTitle = ViewData["OGTitle"]?.ToString() ?? pageTitle;
    string ogDescription = ViewData["OGDescription"]?.ToString() ?? description;
    string ogURL = ViewData["OGURL"]?.ToString() ?? siteURL;
    string canonical = ViewData["Canonical"]?.ToString() ?? siteURL + "/Info/Index";

    // Default Link Share Image (Change as needed)
    string ogImage = ViewData["OGImage"]?.ToString() ?? siteURL + "/Images/LinkImages/SmallLogo.png";
    string ogImageWidth = "1000";
    string ogImageHeight = "1000";

    // Get dynamic colors from ViewBag
    var dynamicColors = ViewBag.DynamicColors as Dictionary<string, string> ?? new Dictionary<string, string>();
           
   
}

<!DOCTYPE html>
<html lang="en">
<head>

    <title>@pageTitle</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="mobile-web-app-capable" content="no">
    <meta name="description" content="@description" />
    <link rel="canonical" href="@canonical" />

    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="lib/icons/apple-touch-icon.png">

    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="192x192" href="favicon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="favicon-512x512.png">
    <link rel="manifest" href="/lib/icons/site.webmanifest">

    <meta property="fb:app_id" content="966242223397117" />

    <meta property="og:type" content="website" />
    <meta property="og:locale" content="en_US" />
    <meta property="og:title" content="@ogTitle" />
    <meta property="og:determiner" content="The" />
    <meta property="og:description" content="@ogDescription" />
    <meta property="og:site_name" content="@ogSite_Name" />
    <meta property="og:url" content="@ogURL" />
    <meta property="og:image:url" content="@ogImage" />
    <meta property="og:image:alt" content="Logo Image" />
    <meta property="og:image:type" content="image/jpeg" />
    <meta property="og:image:width" content=@ogImageWidth />
    <meta property="og:image:height" content=@ogImageHeight />

    <meta name="twitter:card" content="photo" />
    <meta name="twitter:title" content="@ogTitle" />
    <meta name="twitter:image" content="@ogImage" />
    <meta name="twitter:image:width" content=@ogImageWidth />
    <meta name="twitter:image:height" content=@ogImageHeight />
    
    <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

    <!-- Bootstrap 5.3.2 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

    <!-- Bootstrap Font Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />

    <!-- PDF.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css" integrity="sha512-tze+o/xG0w3yxxE8xe32piisVvI/LfcEuf6LW7lFLUxhio2SfFQ9mQ0TqB0avvonmxUXT7/l8+fnWkR03u85fQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" integrity="sha512-q+4liFwdPC/bNdhUpZx6aXDx/h77yEQtn4I1slHydcbZK34nLaR3cAeYSJshoxIOq3mjEf7xJE8YWIUHMn+oCQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Project CSS files FIRST -->
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/fontsize.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/buttons.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/site-colors.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/dynamic-colors.css" asp-append-version="true" />

    <!-- Dynamic Colors LAST to override static CSS -->
    <style>
        :root {
            @foreach (var color in dynamicColors)
            {
                @($"{color.Key}: {color.Value} !important;")
            }
        }
    </style>

    @RenderSection("Styles", required: false)

</head>

<body class="body-bg">  

    <partial name="_PartialHeader" />

    <div id="MainContainer" class="m-0 p-0">
        <main role="main" class="m-0 p-0">
            @RenderBody()
        </main>
    </div>

    <partial name="_PartialFooter" />

    <script>
        //Persistant Footer approach using CSS flexbox-like behavior
        function adjustFooterPositionFlexible() {
            var body = document.body;
            var footer = document.getElementById('footer');

            if (!footer) return;

            // Ensure body takes full height
            if (body.style.minHeight !== '100vh') {
                body.style.minHeight = '100vh';
                body.style.display = 'flex';
                body.style.flexDirection = 'column';
            }

            // Find the main content wrapper (everything before footer)
            var mainContent = document.getElementById('MainContainer');
            if (mainContent && !mainContent.style.flex) {
                mainContent.style.flex = '1';
            }
        }

        // Debounced version to prevent excessive calls during resize
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Use the debounced version for resize events - FIXED TO CALL THE RIGHT FUNCTION
        const debouncedAdjustFooter = debounce(adjustFooterPositionFlexible, 100);

        // Call the function when the page loads and when it resizes - FIXED TO CALL THE RIGHT FUNCTION
        window.addEventListener('load', adjustFooterPositionFlexible);
        window.addEventListener('resize', debouncedAdjustFooter);
        window.addEventListener('DOMContentLoaded', adjustFooterPositionFlexible);

        // Export for external use
        window.adjustFooterPosition = adjustFooterPositionFlexible;
    </script>

    <!-- Global Confirmation Modal -->
    <div class="modal fade" id="globalConfirmModal" tabindex="-1" aria-labelledby="globalConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="globalConfirmModalLabel">Confirm Action</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="globalConfirmModalBody">
                    Are you sure you want to perform this action?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-secondary rounded-2 shadow" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-sm btn-danger rounded-2 shadow" id="globalConfirmButton">
                        <i class="bi bi-check-circle"></i> Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Global Void Modal (with reason input) -->
    <div class="modal fade" id="globalVoidModal" tabindex="-1" aria-labelledby="globalVoidModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="globalVoidModalLabel">Confirm Void</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="globalVoidModalBody" class="mb-3">
                        Are you sure you want to void this item?
                    </div>
                    <div class="mb-3">
                        <label for="globalVoidReasonInput" class="form-label fw-bold" id="globalVoidReasonLabel">Reason:</label>
                        <textarea class="form-control" id="globalVoidReasonInput" rows="3" placeholder="Enter reason for voiding..."></textarea>
                        <div class="text-danger small mt-1" id="globalVoidReasonError" style="display: none;">A reason is required.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-secondary rounded-2 shadow" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-sm btn-danger rounded-2 shadow" id="globalVoidButton">
                        <i class="bi bi-check-circle"></i> Void
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global confirmation modal functionality
        window.showConfirmModal = function(message, onConfirm, options = {}) {
            const modal = document.getElementById('globalConfirmModal');
            const modalBody = document.getElementById('globalConfirmModalBody');
            const modalTitle = document.getElementById('globalConfirmModalLabel');
            const confirmButton = document.getElementById('globalConfirmButton');
            
            // Set message and title
            modalBody.innerHTML = message;
            modalTitle.textContent = options.title || 'Confirm Action';
            
            // Set confirm button text and style
            const buttonText = options.confirmText || 'Confirm';
            const buttonClass = options.dangerous !== false ? 'btn-danger' : 'btn-success';
            confirmButton.className = `btn btn-sm ${buttonClass} rounded-2 shadow`;
            confirmButton.innerHTML = `<i class="bi bi-check-circle"></i> ${buttonText}`;
            
            // Remove any existing event listeners
            const newConfirmButton = confirmButton.cloneNode(true);
            confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);
            
            // Add new event listener
            newConfirmButton.addEventListener('click', function() {
                const bootstrapModal = bootstrap.Modal.getInstance(modal);
                if (bootstrapModal) {
                    bootstrapModal.hide();
                }
                if (typeof onConfirm === 'function') {
                    onConfirm();
                }
            });
            
            // Show the modal
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
            
            return false; // Prevent default form submission
        };

        // Enhanced confirm function that replaces browser's confirm()
        window.confirmAction = function(message, onConfirm, options = {}) {
            return showConfirmModal(message, onConfirm, options);
        };

        // Global void modal functionality with reason input
        window.showVoidModal = function(message, reasonLabel, onConfirm, options = {}) {
            const modal = document.getElementById('globalVoidModal');
            const modalBody = document.getElementById('globalVoidModalBody');
            const modalTitle = document.getElementById('globalVoidModalLabel');
            const reasonLabelElement = document.getElementById('globalVoidReasonLabel');
            const reasonInput = document.getElementById('globalVoidReasonInput');
            const reasonError = document.getElementById('globalVoidReasonError');
            const voidButton = document.getElementById('globalVoidButton');
            
            // Set message, title, and reason label
            modalBody.innerHTML = message;
            modalTitle.textContent = options.title || 'Confirm Void';
            reasonLabelElement.textContent = reasonLabel || 'Reason:';
            
            // Set void button text
            const buttonText = options.confirmText || 'Void';
            voidButton.innerHTML = `<i class="bi bi-check-circle"></i> ${buttonText}`;
            
            // Clear previous input and errors
            reasonInput.value = '';
            reasonError.style.display = 'none';
            reasonInput.classList.remove('is-invalid');
            
            // Remove any existing event listeners
            const newVoidButton = voidButton.cloneNode(true);
            voidButton.parentNode.replaceChild(newVoidButton, voidButton);
            
            // Add new event listener
            newVoidButton.addEventListener('click', function() {
                const reason = reasonInput.value.trim();
                if (!reason) {
                    reasonError.style.display = 'block';
                    reasonInput.classList.add('is-invalid');
                    reasonInput.focus();
                    return;
                }
                
                const bootstrapModal = bootstrap.Modal.getInstance(modal);
                if (bootstrapModal) {
                    bootstrapModal.hide();
                }
                
                if (typeof onConfirm === 'function') {
                    onConfirm(reason);
                }
            });
            
            // Show the modal and focus the reason input
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
            
            // Focus the reason input after modal is shown
            modal.addEventListener('shown.bs.modal', function() {
                reasonInput.focus();
            }, { once: true });
            
            return false; // Prevent default form submission
        };
    </script>
    
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>    
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>

    <script src="~/js/dynamic-colors.js" asp-append-version="true"></script>
   
    @await RenderSectionAsync("Scripts", required: false)

</body>
</html>