﻿@using Microsoft.AspNetCore.Identity
@using System.IO;
@using Microsoft.AspNetCore.Mvc;
@using Microsoft.AspNetCore.Mvc.ViewComponents;
@using Microsoft.EntityFrameworkCore;
@using System.Linq;
@using System.Threading.Tasks;
@using System.Collections.Generic
@using Members.Data;
@using Members.Models;
@inject SignInManager<IdentityUser> SignInManager
@inject UserManager<IdentityUser> UserManager
@inject Members.Data.ApplicationDbContext DbContext

@{
    // Only fetch UserProfile if user is signed in
    Members.Models.UserProfile? userProfile = null; // Change to nullable type
    if (SignInManager.IsSignedIn(User))
    {
        var userId = UserManager.GetUserId(User);
        if (!string.IsNullOrEmpty(userId))
        {
            userProfile = DbContext.UserProfile.FirstOrDefault(up => up.UserId == userId);
        }
    }
}

@{
    if (ViewData.TryGetValue("ParentLayout", out var parentLayout) && parentLayout != null)
    {
        Layout = parentLayout.ToString();
    }
    else
    {
        Layout = "/Areas/Identity/Pages/_Layout.cshtml";
    }
}

<!-- Modern Tab-Based Profile Navigation -->
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-12 col-xl-10">
            
            <!-- Page Title -->
            <div class="text-center mb-4">
                <h1 class="text-black">
                    <i class="bi bi-person-gear"></i> Account Management
                </h1>
                <p class="text-muted">Manage your profile, security, and privacy settings</p>
            </div>

            <!-- Navigation Tabs -->
            <div class="card mb-4">
                <div class="card-header bg-transparent pb-0 border-bottom-0">
                    <ul class="nav nav-tabs" role="tablist">
                        
                        <!-- Profile Tab -->
                        <li class="nav-item">
                            <a class="nav-link @ManageNavPages.IndexNavClass(ViewContext)" 
                               asp-page="./Index" role="tab">
                                <i class="bi bi-person-fill me-2"></i>Profile
                            </a>
                        </li>
                        
                        <!-- Email Tab -->
                        <li class="nav-item">
                            <a class="nav-link @ManageNavPages.EmailNavClass(ViewContext)" 
                               asp-page="./Email" role="tab">
                                <i class="bi bi-envelope-fill me-2"></i>Email
                            </a>
                        </li>
                        
                        <!-- Password Tab -->
                        <li class="nav-item">
                            <a class="nav-link @ManageNavPages.ChangePasswordNavClass(ViewContext)" 
                               asp-page="./ChangePassword" role="tab">
                                <i class="bi bi-lock-fill me-2"></i>Password
                            </a>
                        </li>
                        
                        <!-- Two-Factor Tab -->
                        <li class="nav-item">
                            <a class="nav-link @ManageNavPages.TwoFactorAuthenticationNavClass(ViewContext)" 
                               asp-page="./TwoFactorAuthentication" role="tab">
                                <i class="bi bi-shield-check me-2"></i>Security
                            </a>
                        </li>

                        <!-- Billing Tab (if applicable) -->
                        @if (User.IsInRole("Admin") || User.IsInRole("Manager") || User.IsInRole("Member"))
                        {
                            @if (userProfile != null && userProfile.IsBillingContact && (User.IsInRole("Member")))
                            {
                                <li class="nav-item">
                                    <a class="nav-link" asp-area="Member" asp-page="/MyBilling" role="tab">
                                        <i class="bi bi-card-list me-2"></i>Billing
                                    </a>
                                </li>
                            }
                        }
                    </ul>
                </div>
                
                <!-- Tab Content -->
                <div class="card-body">
                    @RenderBody()
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @RenderSection("Scripts", required: false)
}
